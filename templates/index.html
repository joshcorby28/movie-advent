<!DOCTYPE html>
<html>
<head>
    <title>Reel Season</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(to bottom, #000, #2c2c2c);
            color: #f5f5f5;
        }
        h1, h2 { text-align: center; margin-bottom: 20px; font-weight: 400; }
        form { display:flex; justify-content:center; align-items:center; gap:15px; margin-bottom:40px; flex-wrap:wrap; }
        input, select, button { padding:12px 12px; font-size:0.9rem; border-radius:6px; font-family:'Montserrat', sans-serif; }
        input { width:250px; border:1px solid rgba(255,255,255,0.3); color:#fff; background: rgba(255,255,255,0.1); }
        select { width:250px; appearance: none; border:1px solid rgba(255,255,255,0.3); color:#fff; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="white"><path d="M4 7l3 3 3-3z"/></svg>') no-repeat right 1.5em center / 1.4em, rgba(255,255,255,0.1); padding: 12px 3em 12px 12px; box-shadow: 0 0 1em 0 rgba(0, 0, 0, 0.2); cursor: pointer; }
        select::-ms-expand { display: none; }
        select:focus { outline: none; }
        select option { color: #1b1b1b; background-color: #fff; }
        input::placeholder { color:#ccc; }
        button { background:#fff; color:#1b1b1b; cursor:pointer; border:none; transition:background 0.3s; }
        button:hover { background:#f0f0f0; }
        .calendar { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:35px; max-width:1400px; margin:0 auto 50px auto; }
        .day { background:#1a1a1a; padding:0; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.4); min-height:250px; display:flex; flex-direction:column; overflow:hidden; transition: transform 0.2s, box-shadow 0.2s; }
        .day:hover { transform:translateY(-5px); box-shadow:0 6px 15px rgba(0,0,0,0.6); }
        .day img { border-radius:15px 15px 0 0; width:100%; height:150px; object-fit:cover; }
        .day .content { padding:15px; background: rgba(255,255,255); backdrop-filter: blur(10px); flex-grow:1; display:flex; flex-direction:column; justify-content:space-between; color:#1b1b1b; }
        .day h3 {    min-height: 50px;  margin:0 0 8px 0; font-size:1rem; font-weight:400; }
        .stream-btn { background:#1b1b1b; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-size:0.9rem; }
        .stream-btn:hover { background:#3c3c3c; }
        .replace-btn { background:#ff6600; color:#fff; border:none; padding:6px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem; margin-top:5px; }
        .replace-btn:hover { background:#ff8533; }
        .modal { display:none; position:fixed; z-index:1; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); }
        .modal-content { background-color:#fff; margin:15% auto; padding:20px; border:1px solid #888; width:80%; max-width:400px; border-radius:10px; color:#1b1b1b; text-align:center; }
        .close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
        .close:hover { color:#000; }
        @media(max-width:900px){.calendar{grid-template-columns:repeat(4,1fr);margin:0 20px 40px 20px;}}
        @media(max-width:500px){.calendar{grid-template-columns:repeat(2,1fr);margin:0 10px 30px 10px;} input,select{width:120px;}}

/* Toggle switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    margin-right: 10px;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255,255,255,0.3);
    transition: 0.4s;
    border-radius: 24px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}
input:checked + .slider {
    background-color: #ff6600;
}
input:checked + .slider:before {
    transform: translateX(26px);
}

/* Advanced drawer */
.advanced-drawer {
    position: fixed;
    top: 20px;
    left: -300px;
    width: 280px;
    height: auto;
    background: rgba(0,0,0,0.9);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    transition: left 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.drawer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.drawer-header h3 {
    margin: 0;
    color: #fff;
    font-size: 1.2em;
}
#close-drawer {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5em;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#toggle-advanced:checked ~ .advanced-drawer {
    left: 20px;
}

/* Light mode */
.light-mode {
    background: linear-gradient(to bottom, #fff, #f0f0f0);
    color: #000;
}
.light-mode .day {
    background: #e0e0e0;
}
.light-mode .day .content {
    background: rgba(255,255,255,0.9);
    color: #000;
}
.light-mode input, .light-mode select {
    border:1px solid rgba(0,0,0,0.3);
    color: #000;
    background: rgba(0,0,0,0.1);
}
.light-mode select {
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="black"><path d="M4 7l3 3 3-3z"/></svg>') no-repeat right 1.5em center / 1.4em, rgba(0,0,0,0.1);
}
.light-mode select option {
    color: #000;
    background-color: #fff;
}
.light-mode button {
    background: #000;
    color: #fff;
}
.light-mode button:hover {
    background: #333;
}
.light-mode #theme-toggle {
    background: #1b1b1b !important;
    color: #fff;
}
.light-mode #loadingBar {
    background: #000;
}

        #loadingContainer { text-align:center; margin-bottom:20px; display:none; }
        #loadingBarContainer { background:#333; border-radius:10px; width:30%; margin:0 auto; height:10px; overflow:hidden; }
        #loadingBar { height:100%; width:0%; background:#fff; border-radius:10px; transition: width 0.2s; }
    </style>
</head>
<body>

<h1>Reel Season</h1>

<form id="movieForm">
    <label class="toggle-switch">
        <input type="checkbox" id="toggle-advanced">
        <span class="slider"></span>
    </label>
    <input type="text" name="month" placeholder="October">
    <select name="theme">
        <option value="">Use Month Theme</option>
        <option value="Halloween">Halloween</option>
        <option value="Christmas">Christmas</option>
        <option value="Winter">Winter</option>
        <option value="Spring">Spring</option>
        <option value="Summer">Summer</option>
        <option value="Autumn">Autumn</option>
        <option value="Movies">General Movies</option>
    </select>
    <select name="genre">
        <option value="">All Genres</option>
        <option value="27">Horror</option>
        <option value="35">Comedy</option>
        <option value="10751">Family</option>
        <option value="18">Drama</option>
        <option value="28">Action</option>
        <option value="53">Thriller</option>
        <option value="10749">Romance</option>
        <option value="878">Sci-Fi</option>
        <option value="14">Fantasy</option>
        <option value="16">Animation</option>
    </select>
    <div id="advanced-options" class="advanced-drawer">
        <div class="drawer-header">
            <h3>Advanced Filters</h3>
            <button id="close-drawer" type="button">Ã—</button>
        </div>
        <input type="number" name="year_from" placeholder="From Year">
        <input type="number" name="year_to" placeholder="To Year">
    </div>
    <select name="category">
        <option value="all">All</option>
        <option value="modern">Modern</option>
        <option value="classics">Classics</option>
    </select>
    <button type="submit">âš¡ Generate</button>
    <button type="button" id="save-list" style="background:#28a745; color:#fff; border:none; padding:12px; border-radius:6px; cursor:pointer; margin-left:10px; display:none;">ðŸ’¾ Save List</button>
    <button type="button" id="theme-toggle" style="background:#fff; color:#1b1b1b; border:none; padding:12px; border-radius:6px; cursor:pointer; margin-left:10px;">ðŸŒ™</button>
</form>



<div id="loadingContainer">
    <div id="loadingMessage" style="font-size:1.2rem; margin-bottom:10px;">Generating your movie list...</div>
    <div id="loadingBarContainer"><div id="loadingBar"></div></div>
</div>

<h2 id="movieTitle" style="text-align:center;"></h2>
<div class="calendar" id="calendar"></div>

<div id="streamModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle"></h2>
        <p id="modalProviders"></p>
    </div>
</div>

<script>
const form = document.getElementById('movieForm');
const loadingContainer = document.getElementById('loadingContainer');
const loadingBar = document.getElementById('loadingBar');
const calendar = document.getElementById('calendar');
const movieTitle = document.getElementById('movieTitle');
const modal = document.getElementById('streamModal');
const modalTitle = document.getElementById('modalTitle');
const modalProviders = document.getElementById('modalProviders');
const closeBtn = document.getElementsByClassName('close')[0];

form.addEventListener('submit', async function(e){
    e.preventDefault();  // Prevent normal form POST

    loadingContainer.style.display = 'block';
    loadingBar.style.width = '0%';
    calendar.innerHTML = '';
    movieTitle.innerText = '';
    document.getElementById('save-list').style.display = 'none';

    const formData = new FormData(form);
    const data = {
        month: formData.get('month'),
        theme: formData.get('theme'),
        genre: formData.get('genre'),
        year_from: formData.get('year_from'),
        year_to: formData.get('year_to'),
        category: formData.get('category')
    };

    try {
        const response = await fetch('/get_movies', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if(!response.ok){
            throw new Error(`Server returned ${response.status}`);
        }

        const result = await response.json();
        const movies = result.movies;

        if(!movies || movies.length === 0){
            movieTitle.innerText = "No movies found for this month/category.";
            loadingContainer.style.display = 'none';
            return;
        }

        movieTitle.innerText = result.message || "Get the popcorn and enjoy";

        let progress = 0;
        const increment = 100 / movies.length;

        for (let i = 0; i < movies.length; i++) {
            const movie = movies[i];

            const div = document.createElement('div');
            div.classList.add('day');
            let posterHtml = '';
            if (movie.poster_path) {
                posterHtml = `<img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster" style="width:100%;     max-height: 300px; height:100%;">`;
            }
            div.innerHTML = `
                ${posterHtml}
                <div class="content">
                    <h3>${i + 1}: ${movie.title}</h3>
                    <button class="stream-btn" data-providers="${movie.providers.join(', ')}" data-title="${movie.title}">Stream Now</button>
                    <button class="replace-btn" data-index="${i}">Replace Movie</button>
                </div>`;
            calendar.appendChild(div);

            // Smooth progress increment
            progress += increment;
            if(progress > 100) progress = 100;
            loadingBar.style.width = progress + '%';

            await new Promise(r => setTimeout(r, 30)); // Slight delay for smooth animation
        }

        document.getElementById('save-list').style.display = 'inline-block';

        // Event listeners are added via delegation below

    } catch(err){
        console.error(err);
        movieTitle.innerText = "Error fetching movies. Check console.";
    } finally {
        setTimeout(() => { loadingContainer.style.display = 'none'; }, 300);
    }
});

// Modal close
closeBtn.onclick = function() {
    modal.style.display = 'none';
}
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Theme toggle
const themeToggle = document.getElementById('theme-toggle');
themeToggle.addEventListener('click', function() {
    document.body.classList.toggle('light-mode');
    this.textContent = document.body.classList.contains('light-mode') ? 'â˜€ï¸' : 'ðŸŒ™';
});

// Advanced options toggle
const toggleAdvanced = document.getElementById('toggle-advanced');
const advancedOptions = document.getElementById('advanced-options');
const closeDrawer = document.getElementById('close-drawer');
toggleAdvanced.addEventListener('change', function() {
    if (this.checked) {
        advancedOptions.style.left = '20px';
    } else {
        advancedOptions.style.left = '-300px';
    }
});
closeDrawer.addEventListener('click', function() {
    toggleAdvanced.checked = false;
    advancedOptions.style.left = '-300px';
});

// Replace movie functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('replace-btn')) {
        const index = e.target.getAttribute('data-index');
        const formData = new FormData(document.getElementById('movieForm'));
        const currentTitles = Array.from(document.querySelectorAll('.day h3')).map(h => h.textContent.substring(h.textContent.indexOf(':') + 1).trim());
        const data = {
            month: formData.get('month'),
            theme: formData.get('theme'),
            genre: formData.get('genre'),
            year_from: formData.get('year_from'),
            year_to: formData.get('year_to'),
            category: formData.get('category'),
            current_titles: currentTitles
        };

        fetch('/get_replacement_movie', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.movie) {
                const movie = result.movie;
                const card = e.target.closest('.day');
                let posterHtml = '';
                if (movie.poster_path) {
                    posterHtml = `<img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster">`;
                }
                card.innerHTML = `
                    ${posterHtml}
                    <div class="content">
                        <h3>${parseInt(index) + 1}: ${movie.title}</h3>
                        <button class="stream-btn" data-providers="${movie.providers.join(', ')}" data-title="${movie.title}">Stream Now</button>
                        <button class="replace-btn" data-index="${index}">Replace Movie</button>
                    </div>`;
            } else {
                alert('No replacement movie found.');
            }
        })
        .catch(err => console.error(err));
    }
});

// Stream button functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('stream-btn')) {
        modalTitle.textContent = e.target.getAttribute('data-title');
        modalProviders.textContent = 'Available on: ' + e.target.getAttribute('data-providers');
        modal.style.display = 'block';
    }
});

// Save list functionality
document.getElementById('save-list').addEventListener('click', function() {
    const movies = Array.from(document.querySelectorAll('.day h3')).map(h => h.textContent);
    if (movies.length === 0) {
        alert('No movies to save. Generate a list first.');
        return;
    }
    const listText = movies.join('\n');
    const blob = new Blob([listText], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'movie-list.txt';
    a.click();
    URL.revokeObjectURL(url);
});
</script>

</body>
</html>
