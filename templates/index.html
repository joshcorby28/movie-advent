<!DOCTYPE html>
<html>
<head>
    <title>Reel Season</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body>

<img src="{{ url_for('static', filename='logo.png') }}" alt="Reel Season Logo" style="max-width: 300px; height: auto; margin-bottom: 20px;">
<p style="text-align: center; margin: 0 0 50px 0; font-size: 1.2em; color: #f5f5f5;">Your calendar of chills, cheers, and cinematic magic.</p>

<form id="movieForm">
    <span style="margin-right: 10px; font-size: 1.2em;">‚ò∞</span>
    <label class="toggle-switch">
        <input type="checkbox" id="toggle-advanced">
        <span class="slider"></span>
    </label>
    <input type="text" name="month" placeholder="October">
    <select name="theme">
        <option value="">Use Month Theme</option>
        <option value="Halloween">Halloween</option>
        <option value="Christmas">Christmas</option>
        <option value="Winter">Winter</option>
        <option value="Spring">Spring</option>
        <option value="Summer">Summer</option>
        <option value="Autumn">Autumn</option>
        <option value="Movies">General Movies</option>
    </select>
    <select name="genre">
        <option value="">All Genres</option>
        <option value="27">Horror</option>
        <option value="35">Comedy</option>
        <option value="10751">Family</option>
        <option value="18">Drama</option>
        <option value="28">Action</option>
        <option value="53">Thriller</option>
        <option value="10749">Romance</option>
        <option value="878">Sci-Fi</option>
        <option value="14">Fantasy</option>
        <option value="16">Animation</option>
        <option value="99">Documentary</option>
    </select>
    <div id="advanced-options" class="advanced-drawer">
        <div class="drawer-header">
            <h3>Advanced Filters</h3>
            <button id="close-drawer" type="button">√ó</button>
        </div>
        <input type="number" name="year_from" placeholder="From Year">
        <input type="number" name="year_to" placeholder="To Year">
        <label style="display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.3);">
            <span>Only show streaming movies</span>
            <input type="checkbox" id="only-streaming" name="only_streaming" checked style="width: 20px;">
        </label>
    </div>
    <select name="category">
        <option value="all">All</option>
        <option value="modern">Modern</option>
        <option value="classics">Classics</option>
    </select>
    <button type="submit">‚ö° Generate</button>
    <a href="#" id="try-again" style="color:#f5f5f5; text-decoration: none; font-size: 0.9em; margin-left:10px; display:none;">Try Again</a>
    <a href="#" id="save-list" style="color:#f5f5f5; text-decoration: none; font-size: 0.9em; margin-left:10px; display:none;">Save List</a>
</form>



<div id="loadingContainer">
    <div id="loadingMessage" style="font-size:1.2rem; margin-bottom:10px;">Generating your movie list...</div>
    <div id="loadingBarContainer"><div id="loadingBar"></div></div>
</div>

<h2 id="movieTitle" style="text-align:center;"></h2>
<div class="calendar" id="calendar"></div>

<div id="streamModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle"></h2>
        <p id="modalProviders"></p>
    </div>
</div>

<script>
const form = document.getElementById('movieForm');
const loadingContainer = document.getElementById('loadingContainer');
const loadingBar = document.getElementById('loadingBar');
const calendar = document.getElementById('calendar');
const movieTitle = document.getElementById('movieTitle');
const modal = document.getElementById('streamModal');
const modalTitle = document.getElementById('modalTitle');
const modalProviders = document.getElementById('modalProviders');
const closeBtn = document.getElementsByClassName('close')[0];

form.addEventListener('submit', async function(e){
    e.preventDefault();  // Prevent normal form POST

    loadingContainer.style.display = 'block';
    loadingBar.style.width = '0%';
    calendar.innerHTML = '';
    movieTitle.innerText = '';
    document.getElementById('save-list').style.display = 'none';
    document.getElementById('try-again').style.display = 'none';

    const formData = new FormData(form);
    const data = {
        month: formData.get('month'),
        theme: formData.get('theme'),
        genre: formData.get('genre'),
        year_from: formData.get('year_from'),
        year_to: formData.get('year_to'),
        category: formData.get('category'),
        only_streaming: formData.get('only_streaming') === 'on'
    };

    try {
        const response = await fetch('/get_movies', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if(!response.ok){
            throw new Error(`Server returned ${response.status}`);
        }

        const result = await response.json();
        const movies = result.movies;

        if(!movies || movies.length === 0){
            movieTitle.innerText = "No movies found for this month/category.";
            loadingContainer.style.display = 'none';
            return;
        }

        movieTitle.innerText = result.message || "Get the popcorn and enjoy";

        let progress = 0;
        const increment = 100 / movies.length;

        for (let i = 0; i < movies.length; i++) {
            const movie = movies[i];

            const div = document.createElement('div');
            div.classList.add('day');
            let posterHtml = '';
            if (movie.poster_path) {
                posterHtml = `<div class="poster-container">
                    <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster" style="width:100%; max-height: 300px; height:100%;">
                    <div class="poster-number">${i + 1}</div>
                </div>`;
            } else {
                posterHtml = `<div class="poster-number">${i + 1}</div>`;
            }
            div.innerHTML = `
                ${posterHtml}
                <div class="content">
                    <h3>${movie.title}</h3>
                    <button class="stream-btn" data-providers="${movie.providers.join(', ')}" data-title="${movie.title}">Stream Now</button>
                    <button class="replace-btn" data-index="${i}">Replace Movie</button>
                </div>`;
            calendar.appendChild(div);

            // Smooth progress increment
            progress += increment;
            if(progress > 100) progress = 100;
            loadingBar.style.width = progress + '%';

            await new Promise(r => setTimeout(r, 30)); // Slight delay for smooth animation
        }

        document.getElementById('save-list').style.display = 'inline-block';
        document.getElementById('try-again').style.display = 'inline-block';

        document.body.style.justifyContent = 'flex-start';
        document.body.style.paddingTop = '20px';

        // Event listeners are added via delegation below

    } catch(err){
        console.error(err);
        movieTitle.innerText = "Error fetching movies. Check console.";
    } finally {
        setTimeout(() => { loadingContainer.style.display = 'none'; }, 300);
    }
});

// Modal close
closeBtn.onclick = function() {
    modal.style.display = 'none';
}
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}


// Advanced options toggle
const toggleAdvanced = document.getElementById('toggle-advanced');
const advancedOptions = document.getElementById('advanced-options');
const closeDrawer = document.getElementById('close-drawer');
toggleAdvanced.addEventListener('change', function() {
    if (this.checked) {
        advancedOptions.style.left = '20px';
    } else {
        advancedOptions.style.left = '-300px';
    }
});
closeDrawer.addEventListener('click', function() {
    toggleAdvanced.checked = false;
    advancedOptions.style.left = '-300px';
});

// Replace movie functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('replace-btn')) {
        const index = e.target.getAttribute('data-index');
        const formData = new FormData(document.getElementById('movieForm'));
        const currentTitles = Array.from(document.querySelectorAll('.day h3')).map(h => h.textContent.substring(h.textContent.indexOf(':') + 1).trim());
        const data = {
            month: formData.get('month'),
            theme: formData.get('theme'),
            genre: formData.get('genre'),
            year_from: formData.get('year_from'),
            year_to: formData.get('year_to'),
            category: formData.get('category'),
            only_streaming: formData.get('only_streaming') === 'on',
            current_titles: currentTitles
        };

        fetch('/get_replacement_movie', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.movie) {
                const movie = result.movie;
                const card = e.target.closest('.day');
                let posterHtml = '';
                if (movie.poster_path) {
                    posterHtml = `<div class="poster-container">
                        <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster" style="width:100%; max-height: 300px; height:100%;">
                        <div class="poster-number">${parseInt(index) + 1}</div>
                    </div>`;
                } else {
                    posterHtml = `<div class="poster-number">${parseInt(index) + 1}</div>`;
                }
                card.innerHTML = `
                    ${posterHtml}
                    <div class="content">
                        <h3>${movie.title}</h3>
                        <button class="stream-btn" data-providers="${movie.providers.join(', ')}" data-title="${movie.title}">Stream Now</button>
                        <button class="replace-btn" data-index="${index}">Replace Movie</button>
                    </div>`;
            } else {
                alert('No replacement movie found.');
            }
        })
        .catch(err => console.error(err));
    }
});

// Stream button functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('stream-btn')) {
        modalTitle.textContent = e.target.getAttribute('data-title');
        const providers = e.target.getAttribute('data-providers');
        if (providers === '') {
            modalProviders.textContent = 'Not available on any UK streaming platforms';
        } else {
            modalProviders.textContent = 'Available on: ' + providers;
        }
        modal.style.display = 'block';
    }
});

// Try again functionality
document.getElementById('try-again').addEventListener('click', function() {
    loadingContainer.style.display = 'block';
    loadingBar.style.width = '0%';
    calendar.innerHTML = '';
    movieTitle.innerText = '';

    const formData = new FormData(form);
    const data = {
        month: formData.get('month'),
        theme: formData.get('theme'),
        genre: formData.get('genre'),
        year_from: formData.get('year_from'),
        year_to: formData.get('year_to'),
        category: formData.get('category'),
        only_streaming: formData.get('only_streaming') === 'on',
        try_again: true
    };

    fetch('/get_movies', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        const movies = result.movies;

        if(!movies || movies.length === 0){
            movieTitle.innerText = "No movies found for this month/category.";
            loadingContainer.style.display = 'none';
            return;
        }

        movieTitle.innerText = result.message || "Get the popcorn and enjoy";

        let progress = 0;
        const increment = 100 / movies.length;

        for (let i = 0; i < movies.length; i++) {
            const movie = movies[i];

            const div = document.createElement('div');
            div.classList.add('day');
            let posterHtml = '';
            if (movie.poster_path) {
                posterHtml = `<img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" alt="${movie.title} poster" style="width:100%;     max-height: 300px; height:100%;">`;
            }
            div.innerHTML = `
                ${posterHtml}
                <div class="content">
                    <h3>${i + 1}: ${movie.title}</h3>
                    <button class="stream-btn" data-providers="${movie.providers.join(', ')}" data-title="${movie.title}">Stream Now</button>
                    <button class="replace-btn" data-index="${i}">Replace Movie</button>
                </div>`;
            calendar.appendChild(div);

            progress += increment;
            if(progress > 100) progress = 100;
            loadingBar.style.width = progress + '%';

            // Slight delay for smooth animation
            setTimeout(() => {}, 30);
        }
    })
    .catch(err => {
        console.error(err);
        movieTitle.innerText = "Error fetching movies. Check console.";
    })
    .finally(() => {
        setTimeout(() => { loadingContainer.style.display = 'none'; }, 300);
    });
});

// Save list functionality
document.getElementById('save-list').addEventListener('click', function(e) {
    e.preventDefault();
    const movies = Array.from(document.querySelectorAll('.day h3')).map(h => h.textContent);
    if (movies.length === 0) {
        alert('No movies to save. Generate a list first.');
        return;
    }
    const listText = movies.join('\n');
    const blob = new Blob([listText], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'movie-list.txt';
    a.click();
    URL.revokeObjectURL(url);
});
</script>

<footer style="text-align: center; margin-top: 50px; color: #ccc; font-size: 0.9em;">
    Brought to you by <a href="https://lab-13.co.uk" target="_blank" style="color: #F2F1F0;">Lab13</a>
</footer>

<a href="https://github.com/joshcorby28/movie-advent" target="_blank" style="position: fixed; bottom: 10px; right: 10px; color: #fff; text-decoration: none; font-size: 0.8em;">üêô GitHub</a>

</body>
</html>
