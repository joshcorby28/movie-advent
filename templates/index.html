<!DOCTYPE html>
<html>
<head>
    <title>Reel Season</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body style="padding-top: 60px;">

<header style="position: fixed; top: 0; right: 0; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 0 0 0 10px; z-index: 1000;">
    {% if user.is_authenticated %}
        <span style="color: #f5f5f5; margin-right: 10px;">Welcome, {{ user.username }}!</span>
        <a href="{{ url_for('my_lists') }}" style="color: #f5f5f5; text-decoration: none; margin-right: 10px;">My Lists</a>
        <a href="{{ url_for('logout') }}" style="color: #f5f5f5; text-decoration: none;">Logout</a>
    {% else %}
        <a href="{{ url_for('login') }}" style="color: #f5f5f5; text-decoration: none; margin-right: 10px;">Login</a>
        <a href="{{ url_for('register') }}" style="color: #f5f5f5; text-decoration: none;">Register</a>
    {% endif %}
</header>

<a href="{{ url_for('index') }}" style="text-decoration: none;"><img src="{{ url_for('static', filename='logo.png') }}" alt="Reel Season Logo" style="max-width: 300px; height: auto; margin-bottom: 20px; margin-top: 20px;"></a>
<p style="text-align: center; margin: 0 0 50px 0; font-size: 1.2em; color: #f5f5f5;">Your calendar of chills, cheers, and cinematic magic.</p>

<form id="movieForm">
    <span style="margin-right: 10px; font-size: 1.2em;">☰</span>
    <label class="toggle-switch">
        <input type="checkbox" id="toggle-advanced">
        <span class="slider"></span>
    </label>
    <select name="month" id="monthSelect">
        <option value="">Select Month</option>
        <option value="January">January (31 days)</option>
        <option value="February">February (28 days)</option>
        <option value="March">March (31 days)</option>
        <option value="April">April (30 days)</option>
        <option value="May">May (31 days)</option>
        <option value="June">June (30 days)</option>
        <option value="July">July (31 days)</option>
        <option value="August">August (31 days)</option>
        <option value="September">September (30 days)</option>
        <option value="October">October (31 days)</option>
        <option value="November">November (30 days)</option>
        <option value="December">December (31 days)</option>
    </select>
    <select name="theme">
        <option value="">Use Month Theme</option>
        <option value="Halloween">Halloween</option>
        <option value="Christmas">Christmas</option>
        <option value="Winter">Winter</option>
        <option value="Spring">Spring</option>
        <option value="Summer">Summer</option>
        <option value="Autumn">Autumn</option>
        <option value="Movies">General Movies</option>
    </select>
    <select name="genre">
        <option value="">All Genres</option>
        <option value="27">Horror</option>
        <option value="35">Comedy</option>
        <option value="10751">Family</option>
        <option value="18">Drama</option>
        <option value="28">Action</option>
        <option value="53">Thriller</option>
        <option value="10749">Romance</option>
        <option value="878">Sci-Fi</option>
        <option value="14">Fantasy</option>
        <option value="16">Animation</option>
        <option value="99">Documentary</option>
    </select>
    <div id="advanced-options" class="advanced-drawer">
        <div class="drawer-header">
            <h3>Advanced Filters</h3>
            <button id="close-drawer" type="button">×</button>
        </div>
        <input type="number" name="year_from" placeholder="From Year">
        <input type="number" name="year_to" placeholder="To Year">
        <div style="background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.3);">
            <label>Streaming Services:</label><br>
            <label><input type="checkbox" id="netflix" name="services" value="8" checked> Netflix</label><br>
            <label><input type="checkbox" id="amazon" name="services" value="9" checked> Amazon Prime</label><br>
            <label><input type="checkbox" id="disney" name="services" value="337" checked> Disney+</label><br>
            <label><input type="checkbox" id="paramount" name="services" value="531"> Paramount+</label><br>
            <label><input type="checkbox" id="apple" name="services" value="350"> Apple TV</label><br>
            <hr style="border: none; border-top: 1px solid rgba(255, 255, 255, 0.3); margin: 10px 0;">
            <label style="display: flex; align-items: center;">
                <input type="checkbox" id="show-non-streaming" name="show_non_streaming" style="width: 20px; margin-right: 10px;">
                <span>Show non-streaming movies</span>
            </label>
        </div>
    </div>
    <select name="category">
        <option value="all">All</option>
        <option value="modern">Modern</option>
        <option value="classics">Classics</option>
    </select>
    <button type="submit">⚡ Generate</button>
    <a href="#" id="try-again" style="color:#f5f5f5; text-decoration: none; font-size: 0.9em; margin-left:10px; display:none;">Try Again</a>
    <a href="#" id="save-list" style="color:#f5f5f5; text-decoration: none; font-size: 0.9em; margin-left:10px; display:none;">Save List</a>
</form>



<div id="loadingContainer">
    <div id="loadingMessage" style="font-size:1.2rem; margin-bottom:10px;">Generating your movie list... 0%</div>
</div>

<h2 id="movieTitle" style="text-align:center;"></h2>
<div class="calendar" id="calendar"></div>

<div id="streamModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle"></h2>
        <p id="modalProviders"></p>
    </div>
</div>

<div id="saveModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span class="close" id="saveModalClose">&times;</span>
        <h2>Save Your Movie List</h2>
        <input type="text" id="listName" placeholder="Enter list name" style="width: 80%; padding: 10px; margin: 20px 0; border: none; border-radius: 5px; font-size: 16px;">
        <br>
        <button id="saveConfirm" style="padding: 10px 20px; background: #1b1b1b; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Save</button>
        <button id="saveCancel" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
    </div>
</div>

<div id="messageModal" class="modal">
    <div class="modal-content" style="text-align: center;">
        <span class="close" id="messageModalClose">&times;</span>
        <h2 id="messageTitle"></h2>
        <p id="messageText"></p>
        <button id="messageOK" style="padding: 10px 20px; background: #1b1b1b; color: white; border: none; border-radius: 5px; cursor: pointer;">OK</button>
        <button id="messageCancel" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; display: none;">Cancel</button>
    </div>
</div>

<div id="searchModal" class="modal">
    <div class="modal-content" style="text-align: center; max-width: 800px;">
        <span class="close" id="searchModalClose">&times;</span>
        <h2>Search for a Movie</h2>
        <input type="text" id="movieSearchInput" placeholder="Enter movie name..." style="width: 80%; padding: 12px; margin: 20px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
        <button id="movieSearchBtn" style="padding: 12px 20px; background: #1b1b1b; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Search</button>
        <div id="searchLoading" style="display: none; margin: 20px 0;">Searching...</div>
        <div id="searchResults" style="max-height: 400px; overflow-y: auto; text-align: left; margin-top: 20px;"></div>
    </div>
</div>

<div id="movieModal" class="modal">
    <div class="modal-content">
        <span class="close" id="movieModalClose">&times;</span>
        <div class="movie-poster-container">
            <img id="movieModalPoster" src="" alt="Movie Poster">
        </div>
        <div class="movie-details">
            <h2 id="movieModalTitle"></h2>
            <p id="movieModalPlot"></p>
            <div id="movieModalMeta"></div>
        </div>
    </div>
</div>

<script>
const isAuthenticated = {{ user.is_authenticated | tojson }};
const form = document.getElementById('movieForm');
let generationData = null;
const loadingContainer = document.getElementById('loadingContainer');
const loadingBar = document.getElementById('loadingBar');
const calendar = document.getElementById('calendar');
const movieTitle = document.getElementById('movieTitle');
const modal = document.getElementById('streamModal');
const modalTitle = document.getElementById('modalTitle');
const modalProviders = document.getElementById('modalProviders');
const closeBtn = document.getElementsByClassName('close')[0];
const messageModal = document.getElementById('messageModal');
const messageTitle = document.getElementById('messageTitle');
const messageText = document.getElementById('messageText');
const messageOK = document.getElementById('messageOK');
const messageCancel = document.getElementById('messageCancel');
const messageModalClose = document.getElementById('messageModalClose');

// Movie modal elements
const movieModal = document.getElementById('movieModal');
const movieModalTitle = document.getElementById('movieModalTitle');
const movieModalPoster = document.getElementById('movieModalPoster');
const movieModalPlot = document.getElementById('movieModalPlot');
const movieModalMeta = document.getElementById('movieModalMeta');
const movieModalClose = document.getElementById('movieModalClose');

// Search modal elements
const searchModal = document.getElementById('searchModal');
const searchModalClose = document.getElementById('searchModalClose');
const movieSearchInput = document.getElementById('movieSearchInput');
const movieSearchBtn = document.getElementById('movieSearchBtn');
const searchResults = document.getElementById('searchResults');
const searchLoading = document.getElementById('searchLoading');

form.addEventListener('submit', function(e){
    e.preventDefault();  // Prevent normal form POST

    loadingContainer.style.display = 'block';
    calendar.innerHTML = '';
    movieTitle.innerText = '';
    document.getElementById('save-list').style.display = 'none';
    document.getElementById('try-again').style.display = 'none';

    const formData = new FormData(form);
    const services = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(cb => cb.value);
    const data = {
        month: formData.get('month'),
        theme: formData.get('theme'),
        genre: formData.get('genre'),
        year_from: formData.get('year_from'),
        year_to: formData.get('year_to'),
        category: formData.get('category'),
        keywords: formData.get('keywords'),
        only_streaming: !document.getElementById('show-non-streaming').checked,
        services: services
    };
    generationData = { ...data };

    let percent = 0;
    const interval = setInterval(() => {
        percent += 1;
        if (percent > 99) percent = 99;
        loadingMessage.innerText = `Generating your movie list... ${percent}%`;
    }, 100);

    fetch('/get_movies', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => {
        if(!response.ok){
            throw new Error(`Server returned ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        clearInterval(interval);
        percent = 100;
        loadingMessage.innerText = `Generating your movie list... ${percent}%`;
        const movies = result.movies;

        if(!movies || movies.length === 0){
            movieTitle.innerText = "No movies found for this month/category.";
            loadingContainer.style.display = 'none';
            return;
        }

        movieTitle.innerText = result.message || "Get the popcorn and enjoy";

        // Add month day count if a month was selected (show above the main title)
        if (selectedMonth && monthDays[selectedMonth] !== undefined) {
            const dayCountSpan = document.createElement('div');
            dayCountSpan.style.color = '#ccc';
            dayCountSpan.style.fontSize = '0.9em';
            dayCountSpan.style.marginBottom = '10px';
            dayCountSpan.textContent = `${monthDays[selectedMonth]} days of movies`;
            movieTitle.insertBefore(dayCountSpan, movieTitle.firstChild);
        }


        let progress = 0;
        const increment = 100 / movies.length;

        for (let i = 0; i < movies.length; i++) {
            const movie = movies[i];

            const div = document.createElement('div');
            div.classList.add('day');
            let posterHtml = '';
            if (movie.poster_path) {
                posterHtml = `<div class="poster-container" style="position: relative;">
                    <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title} poster" style="width:100%; max-height: 300px; height:100%;">
                    <div class="poster-number">${i + 1}</div>
                    <div class="info-icon" data-movie-index="${i}" data-movie-title="${movie.title}" data-movie-id="${movie.id}" data-movie-poster="https://image.tmdb.org/t/p/original${movie.poster_path}" style="position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border-radius: 50%; background:#fff; color: #1b1b1b; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; font-weight: bold; z-index: 0;">i</div>
                </div>`;
            } else {
                posterHtml = `<div class="poster-number">${i + 1}</div>`;
            }
            div.innerHTML = `
                ${posterHtml}
                <div class="content">
                    <h3>${movie.title}</h3>
                    <button class="stream-btn" data-providers="${movie.providers.join(', ')}" data-title="${movie.title}">Stream Now</button>
                    <button class="replace-btn" data-index="${i}">Replace Movie</button>
                </div>`;
            calendar.appendChild(div);

            // Update progress
            progress += increment;
            if(progress > 100) progress = 100;
            loadingMessage.innerText = `Generating your movie list... ${Math.round(progress)}%`;

            // Slight delay for smooth animation
            setTimeout(() => {}, 30);
        }

        document.getElementById('save-list').style.display = 'inline-block';
        document.getElementById('try-again').style.display = 'inline-block';

        document.body.style.justifyContent = 'flex-start';
        document.body.style.paddingTop = '20px';

        // Event listeners are added via delegation below
    })
    .catch(err => {
        console.error(err);
        movieTitle.innerText = "Error fetching movies. Check console.";
        clearInterval(interval);
    })
    .finally(() => {
        setTimeout(() => { loadingContainer.style.display = 'none'; }, 300);
    });
});

// Modal close
closeBtn.onclick = function() {
    modal.style.display = 'none';
}
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
    if (event.target == messageModal) {
        messageModal.style.display = 'none';
    }
    if (event.target == movieModal) {
        movieModal.style.display = 'none';
    }
    if (event.target == searchModal) {
        searchModal.style.display = 'none';
    }
}
messageModalClose.onclick = function() {
    messageModal.style.display = 'none';
}
movieModalClose.onclick = function() {
    movieModal.style.display = 'none';
}
searchModalClose.onclick = function() {
    searchModal.style.display = 'none';
}

function showMessage(title, text, onOK, onCancel) {
    messageTitle.textContent = title;
    messageText.textContent = text;
    messageOK.onclick = () => { messageModal.style.display = 'none'; if(onOK) onOK(); };
    if(onCancel) {
        messageCancel.style.display = 'inline-block';
        messageCancel.onclick = () => { messageModal.style.display = 'none'; onCancel(); };
    } else {
        messageCancel.style.display = 'none';
    }
    messageModal.style.display = 'block';
}


// Advanced options toggle
const toggleAdvanced = document.getElementById('toggle-advanced');
const advancedOptions = document.getElementById('advanced-options');
const closeDrawer = document.getElementById('close-drawer');
toggleAdvanced.addEventListener('change', function() {
    if (this.checked) {
        advancedOptions.style.left = '20px';
    } else {
        advancedOptions.style.left = '-300px';
    }
});
closeDrawer.addEventListener('click', function() {
    toggleAdvanced.checked = false;
    advancedOptions.style.left = '-300px';
});

// Search functionality
function searchMovies(query) {
    searchLoading.style.display = 'block';
    searchResults.innerHTML = '';

    fetch(`/search_movies?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            searchLoading.style.display = 'none';
            console.log('Search response:', data);

            if (data.error) {
                searchResults.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                return;
            }

            if (!data.movies || data.movies.length === 0) {
                searchResults.innerHTML = '<p>No movies found. Try a different search term.</p>';
                return;
            }

            searchResults.innerHTML = ''; // Clear previous results

            data.movies.forEach((movie, index) => {
                console.log(`Processing movie ${index + 1}:`, movie);

                const movieDiv = document.createElement('div');
                movieDiv.className = 'search-result-item';
                movieDiv.style.cssText = `
                    display: flex;
                    align-items: center;
                    padding: 15px;
                    margin: 10px 0;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: background-color 0.2s;
                `;

                movieDiv.onmouseover = () => movieDiv.style.backgroundColor = '#f5f5f5';
                movieDiv.onmouseout = () => movieDiv.style.backgroundColor = 'transparent';

                // Properly escape the JSON data for HTML attribute - use single quotes for HTML attribute
                const movieData = encodeURIComponent(JSON.stringify(movie));
                console.log(`Movie data for button: ${movieData.substring(0, 100)}...`);

                movieDiv.innerHTML = `
                    <img src="https://image.tmdb.org/t/p/w200${movie.poster_path}"
                         alt="${movie.title.replace(/"/g, '"')}"
                         style="width: 60px; height: 90px; object-fit: cover; border-radius: 5px; margin-right: 15px;"
                         onerror="this.src='/static/placeholder.jpg'">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">${movie.title.replace(/</g, '<').replace(/>/g, '>')}</div>
                        <div style="color: #666; font-size: 0.9em;">${movie.release_date ? new Date(movie.release_date).getFullYear() : 'Unknown Year'}</div>
                        <div style="color: #888; font-size: 0.8em; margin-top: 3px;">Rating: ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'}/10</div>
                    </div>
                        <button 
                        class="select-movie-btn" 
                        data-movie="${movieData}"
                        style="padding: 8px 16px; background: #1b1b1b; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Select
                        </button>

                `;

                searchResults.appendChild(movieDiv);
            });

            // Add event listeners for select buttons after they're created
            const selectButtons = document.querySelectorAll('.select-movie-btn');
            console.log('Found select buttons:', selectButtons.length);

            selectButtons.forEach((btn, index) => {
                console.log(`Adding event listener to button ${index + 1}`);
                console.log('Button element:', btn);
                console.log('Button data-movie:', btn.getAttribute('data-movie'));
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('=== SELECT BUTTON CLICKED ===');
                    console.log('Button element:', this);
                    console.log('Button data-movie attribute:', this.getAttribute('data-movie'));
                    console.log('Search modal display:', searchModal.style.display);

                    try {
                        const movieData = this.getAttribute('data-movie');
                        if (!movieData) {
                            console.error('No movie data found in button');
                            alert('Error: No movie data found in button');
                            return;
                        }

                        console.log('Raw movie data length:', movieData.length);
                        console.log('Raw movie data preview:', movieData.substring(0, 200) + '...');

                        const movie = JSON.parse(decodeURIComponent(movieData));
                        console.log('Successfully parsed movie:', movie);
                        console.log('Movie title:', movie.title);
                        selectMovieForReplacement(movie);
                    } catch (error) {
                        console.error('Error parsing movie data:', error);
                        console.error('Raw data was:', this.getAttribute('data-movie'));
                        alert('Error parsing movie data: ' + error.message);
                    }
                });
            });
        })
        .catch(error => {
            searchLoading.style.display = 'none';
            searchResults.innerHTML = `<p style="color: red;">Error searching movies: ${error.message}</p>`;
        });
}

function selectMovieForReplacement(movie) {
    console.log('=== SELECT MOVIE FOR REPLACEMENT CALLED ===');
    console.log('Movie to replace with:', movie);
    console.log('Movie title:', movie.title);

    // Close search modal
    console.log('Closing search modal...');
    searchModal.style.display = 'none';
    console.log('Search modal display set to:', searchModal.style.display);

    // Find the replace button that opened the search
    console.log('Looking for active replace button with class "replace-btn.search-active"');
    const activeReplaceBtn = document.querySelector('.replace-btn.search-active');
    console.log('Active replace button found:', activeReplaceBtn);

    if (!activeReplaceBtn) {
        console.error('No active replace button found');
        console.error('Available replace buttons:', document.querySelectorAll('.replace-btn').length);
        console.error('Buttons with search-active class:', document.querySelectorAll('.search-active').length);
        alert('Error: Could not find the movie to replace. Please try again.');
        return;
    }

    const index = activeReplaceBtn.getAttribute('data-index');
    console.log('Movie index to replace:', index);

    const card = activeReplaceBtn.closest('.day');
    console.log('Card element found:', card);

    if (!card) {
        console.error('No card found for replacement');
        alert('Error: Could not find the movie card. Please try again.');
        return;
    }

    console.log('Replacing movie at index:', index, 'with:', movie.title);
    console.log('DEBUG: Movie data for replacement:', {
        id: movie.id,
        title: movie.title,
        poster_path: movie.poster_path,
        hasRequiredData: !!(movie.id && movie.poster_path)
    });

    // Update the card with selected movie
    card.innerHTML = '';

    let posterElement;
    if (movie.poster_path) {
        const posterContainer = document.createElement('div');
        posterContainer.className = 'poster-container';
        posterContainer.style.position = 'relative';

        const img = document.createElement('img');
        img.src = `https://image.tmdb.org/t/p/w500${movie.poster_path}`;
        img.alt = `${movie.title} poster`;
        img.style.width = '100%';
        img.style.maxHeight = '300px';
        img.style.height = '100%';
        posterContainer.appendChild(img);

        const numberDiv = document.createElement('div');
        numberDiv.className = 'poster-number';
        numberDiv.textContent = parseInt(index) + 1;
        posterContainer.appendChild(numberDiv);

        // ADD INFO ICON - This was missing!
        const infoIcon = document.createElement('div');
        infoIcon.className = 'info-icon';
        infoIcon.setAttribute('data-movie-index', index);
        infoIcon.setAttribute('data-movie-title', movie.title);
        infoIcon.setAttribute('data-movie-id', movie.id);
        infoIcon.setAttribute('data-movie-poster', `https://image.tmdb.org/t/p/original${movie.poster_path}`);
        infoIcon.style.cssText = 'position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border-radius: 50%; background:#fff; color: #1b1b1b; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; font-weight: bold; z-index: 0;';
        infoIcon.textContent = 'i';
        posterContainer.appendChild(infoIcon);

        console.log('DEBUG: Added info icon to replaced movie:', movie.title);
        posterElement = posterContainer;
    } else {
        const numberDiv = document.createElement('div');
        numberDiv.className = 'poster-number';
        numberDiv.textContent = parseInt(index) + 1;
        posterElement = numberDiv;
    }
    card.appendChild(posterElement);

    const contentDiv = document.createElement('div');
    contentDiv.className = 'content';
    const h3 = document.createElement('h3');
    h3.textContent = movie.title;
    contentDiv.appendChild(h3);
    const streamBtn = document.createElement('button');
    streamBtn.className = 'stream-btn';
    streamBtn.setAttribute('data-providers', 'Netflix,Amazon Prime Video,Disney+');
    streamBtn.setAttribute('data-title', movie.title);
    streamBtn.textContent = 'Stream Now';
    contentDiv.appendChild(streamBtn);
    const newReplaceBtn = document.createElement('button');
    newReplaceBtn.className = 'replace-btn';
    newReplaceBtn.setAttribute('data-index', index);
    newReplaceBtn.textContent = 'Replace Movie';
    contentDiv.appendChild(newReplaceBtn);
    card.appendChild(contentDiv);

    // Remove search-active class
    activeReplaceBtn.classList.remove('search-active');

    console.log('Movie replacement completed successfully');
}

// Search button functionality
movieSearchBtn.addEventListener('click', function() {
    const query = movieSearchInput.value.trim();
    if (query) {
        searchMovies(query);
    }
});

movieSearchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const query = this.value.trim();
        if (query) {
            searchMovies(query);
        }
    }
});

// Replace movie functionality - now opens search modal
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('replace-btn')) {
        console.log('=== REPLACE BUTTON CLICKED ===');
        console.log('Replace button element:', e.target);
        console.log('Replace button classes:', e.target.classList.toString());

        if (!generationData) {
            console.log('No generation data found, showing message');
            showMessage('No List Generated', 'Please generate a movie list first.');
            return;
        }

        // Mark this button as active for search
        e.target.classList.add('search-active');
        console.log('Added search-active class to button');
        console.log('Button classes after adding search-active:', e.target.classList.toString());
        console.log('Button data-index:', e.target.getAttribute('data-index'));

        console.log('Search modal element:', searchModal);
        console.log('Search modal display before:', searchModal.style.display);

        // Show search modal
        searchModal.style.display = 'block';
        console.log('Search modal display set to block');
        console.log('Search modal display after:', searchModal.style.display);

        movieSearchInput.focus();
        movieSearchInput.value = ''; // Clear previous search

        console.log('Replace button setup completed');
    }
});

// Stream button functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('stream-btn')) {
        modalTitle.textContent = e.target.getAttribute('data-title');
        const providers = e.target.getAttribute('data-providers');
        if (providers === '') {
            modalProviders.textContent = 'Not available on any UK streaming platforms';
        } else {
            modalProviders.textContent = 'Available on: ' + providers;
        }
        modal.style.display = 'block';
    }
});

// Info icon functionality
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('info-icon')) {
        const title = e.target.getAttribute('data-movie-title');
        const movieId = e.target.getAttribute('data-movie-id');
        const poster = e.target.getAttribute('data-movie-poster');

        // Fetch detailed movie information from the backend
        fetch(`/movie/${movieId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch movie details');
                }
                return response.json();
            })
            .then(movieDetails => {
                movieModalTitle.textContent = movieDetails.title || title;
                movieModalPlot.textContent = movieDetails.overview || movieDetails.plot || 'Plot information is not available for this movie in our database.';
                movieModalPoster.src = poster;
                movieModalPoster.alt = `${title} poster`;

                // Add or update rating badge in modal
                let ratingBadge = document.querySelector('#movieModal .modal-rating-badge');
                if (!ratingBadge) {
                    ratingBadge = document.createElement('div');
                    ratingBadge.className = 'modal-rating-badge';
                    movieModal.querySelector('.modal-content').appendChild(ratingBadge);
                }
                ratingBadge.textContent = movieDetails.vote_average ? movieDetails.vote_average.toFixed(1) : 'N/A';

                // Add movie metadata
                const year = movieDetails.release_date ? new Date(movieDetails.release_date).getFullYear() : '';
                const rating = movieDetails.vote_average ? `${movieDetails.vote_average}/10` : '';
                const runtime = movieDetails.runtime ? `${movieDetails.runtime} min` : '';
                const genres = movieDetails.genres ? movieDetails.genres.join(', ') : '';
                const tagline = movieDetails.tagline || '';

                let metaHtml = '<div style="margin-top: 15px; font-size: 0.9em; color: #888;">';

                if (year) metaHtml += `<div><strong>Year:</strong> ${year}</div>`;
                if (rating) metaHtml += `<div><strong>Rating:</strong> ${rating}</div>`;
                if (runtime) metaHtml += `<div><strong>Runtime:</strong> ${runtime}</div>`;
                if (genres) metaHtml += `<div><strong>Genres:</strong> ${genres}</div>`;

                if (!year && !rating && !runtime && !genres && !tagline) {
                    metaHtml += '<div>Movie details are limited in our database.</div>';
                }

                metaHtml += '</div>';
                movieModalMeta.innerHTML = metaHtml;

                movieModal.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching movie details:', error);
                // Enhanced fallback with more helpful information
                movieModalTitle.textContent = title;
                movieModalPlot.textContent = 'Unable to load detailed plot information for this movie. This might be due to limited data availability in the movie database.';
                movieModalPoster.src = poster;
                movieModalPoster.alt = `${title} poster`;

                // Add rating badge even for fallback (show N/A)
                let ratingBadge = document.querySelector('#movieModal .modal-rating-badge');
                if (!ratingBadge) {
                    ratingBadge = document.createElement('div');
                    ratingBadge.className = 'modal-rating-badge';
                    movieModal.querySelector('.modal-content').appendChild(ratingBadge);
                }
                ratingBadge.textContent = 'N/A';

                // Provide helpful metadata even when API fails
                movieModalMeta.innerHTML = `
                    <div style="margin-top: 15px; font-size: 0.9em; color: #888;">
                        <div>Movie details could not be loaded from the database.</div>
                        <div style="margin-top: 10px; color: #666;">
                            <strong>What you can try:</strong><br>
                            • Check if the movie has limited information available<br>
                            • Some older or less popular movies may not have detailed descriptions<br>
                            • The movie database might be temporarily unavailable
                        </div>
                    </div>
                `;
                movieModal.style.display = 'block';
            });
    }
});

// Try again functionality
document.getElementById('try-again').addEventListener('click', function() {
    loadingContainer.style.display = 'block';
    calendar.innerHTML = '';
    movieTitle.innerText = '';

    const formData = new FormData(form);
    const services = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(cb => cb.value);
    const data = {
        month: formData.get('month'),
        theme: formData.get('theme'),
        genre: formData.get('genre'),
        year_from: formData.get('year_from'),
        year_to: formData.get('year_to'),
        category: formData.get('category'),
        keywords: formData.get('keywords'),
        only_streaming: !document.getElementById('show-non-streaming').checked,
        services: services,
        try_again: true
    };

    let percent = 0;
    const interval = setInterval(() => {
        percent += 1;
        if (percent > 99) percent = 99;
        loadingMessage.innerText = `Generating your movie list... ${percent}%`;
    }, 100);

    fetch('/get_movies', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        clearInterval(interval);
        percent = 100;
        loadingMessage.innerText = `Generating your movie list... ${percent}%`;
        const movies = result.movies;

        if(!movies || movies.length === 0){
            movieTitle.innerText = "No movies found for this month/category.";
            loadingContainer.style.display = 'none';
            return;
        }

        movieTitle.innerText = result.message || "Get the popcorn and enjoy";

        let progress = 0;
        const increment = 100 / movies.length;

        for (let i = 0; i < movies.length; i++) {
            const movie = movies[i];

            const div = document.createElement('div');
            div.classList.add('day');
            let posterHtml = '';
            if (movie.poster_path) {
                posterHtml = `<div class="poster-container" style="position: relative;">
                    <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title} poster" style="width:100%; max-height: 300px; height:100%;">
                    <div class="info-icon" data-movie-title="${movie.title}" data-movie-id="${movie.id}" data-movie-poster="https://image.tmdb.org/t/p/original${movie.poster_path}" style="position: absolute; top: 5px; right: 5px; width: 20px; height: 20px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; font-weight: bold; z-index: 0;">i</div>
                </div>`;
            }
            div.innerHTML = `
                ${posterHtml}
                <div class="content">
                    <h3>${i + 1}: ${movie.title}</h3>
                    <button class="stream-btn" data-providers="${movie.providers.join(', ')}" data-title="${movie.title}">Stream Now</button>
                    <button class="replace-btn" data-index="${i}">Replace Movie</button>
                </div>`;
            calendar.appendChild(div);

            progress += increment;
            if(progress > 100) progress = 100;
            loadingMessage.innerText = `Generating your movie list... ${Math.round(progress)}%`;

            // Slight delay for smooth animation
            setTimeout(() => {}, 30);
        }
    })
    .catch(err => {
        console.error(err);
        movieTitle.innerText = "Error fetching movies. Check console.";
        clearInterval(interval);
    })
    .finally(() => {
        setTimeout(() => { loadingContainer.style.display = 'none'; }, 300);
    });
});

// Save list functionality
document.getElementById('save-list').addEventListener('click', function(e) {
    e.preventDefault();
    const movies = Array.from(document.querySelectorAll('.day')).map(day => {
        const title = day.querySelector('h3').textContent;
        const providers = day.querySelector('.stream-btn').getAttribute('data-providers');
        const posterPath = day.querySelector('img') ? day.querySelector('img').src.replace('https://image.tmdb.org/t/p/w200', '') : null;
        return { title, providers: providers.split(', '), poster_path: posterPath };
    });
    if (movies.length === 0) {
        showMessage('No Movies', 'No movies to save. Generate a list first.');
        return;
    }
    if (isAuthenticated) {
        document.getElementById('saveModal').style.display = 'block';
        document.getElementById('listName').focus();
    } else {
        const listText = movies.map(m => m.title).join('\n');
        const blob = new Blob([listText], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'movie-list.txt';
        a.click();
        URL.revokeObjectURL(url);
    }
});

// Save modal functionality
document.getElementById('saveConfirm').addEventListener('click', function() {
    const name = document.getElementById('listName').value.trim();
    if (!name) {
        showMessage('Invalid Name', 'Please enter a name for your list.');
        return;
    }
    const movies = Array.from(document.querySelectorAll('.day')).map(day => {
        const title = day.querySelector('h3').textContent;
        const providers = day.querySelector('.stream-btn').getAttribute('data-providers');
        const posterPath = day.querySelector('img') ? day.querySelector('img').src.replace('https://image.tmdb.org/t/p/w200', '') : null;
        return { title, providers: providers.split(', '), poster_path: posterPath };
    });
    fetch('/save_list', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, movies })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showMessage('Success', 'List saved successfully!');
            document.getElementById('saveModal').style.display = 'none';
            document.getElementById('listName').value = '';
        } else {
            showMessage('Error', 'Failed to save list.');
        }
    })
    .catch(err => console.error(err));
});

document.getElementById('saveCancel').addEventListener('click', function() {
    document.getElementById('saveModal').style.display = 'none';
    document.getElementById('listName').value = '';
});

document.getElementById('saveModalClose').addEventListener('click', function() {
    document.getElementById('saveModal').style.display = 'none';
    document.getElementById('listName').value = '';
});

window.addEventListener('click', function(event) {
    const modal = document.getElementById('saveModal');
    if (event.target == modal) {
        modal.style.display = 'none';
        document.getElementById('listName').value = '';
    }
});

// Month selection functionality
const monthSelect = document.getElementById('monthSelect');

// Month days mapping (accounting for leap year - using 28 for February)
const monthDays = {
    'January': 31, 'February': 28, 'March': 31, 'April': 30,
    'May': 31, 'June': 30, 'July': 31, 'August': 31,
    'September': 30, 'October': 31, 'November': 30, 'December': 31
};

// Store the selected month for later use
let selectedMonth = '';

monthSelect.addEventListener('change', function() {
    selectedMonth = this.value;
});
</script>

<a href="https://lab-13.co.uk" target="_blank" style="position: fixed; bottom: 10px; left: 10px; color: #F2F1F0; text-decoration: none; font-size: 0.9em;">Brought to you by Lab13</a>

<a href="https://github.com/joshcorby28/movie-advent" target="_blank" style="position: fixed; bottom: 10px; right: 10px; color: #fff; text-decoration: none; font-size: 0.8em;"><img src="{{ url_for('static', filename='github-mark-white.svg') }}" alt="GitHub" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;">GitHub</a>

</body>
</html>
